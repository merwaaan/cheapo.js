<!doctype html>
<head>
  <title>Cheapo â€” A Javascript CHIP-8 emulator</title>
  <meta charset="utf-8">

  <script src="src/cpu.js"></script>
  <script src="src/video.js"></script>
  <script src="src/audio.js"></script>
  <script src="src/input.js"></script>
  <script src="src/main.js"></script>

  <script src="libs/dat.gui.min.js"></script>

  <link rel="stylesheet" type="text/css" href="screen.css"/>
</head>
<body>

  <header>
    <h1>Cheapo</h1><br/>
    <h2>A Javascript CHIP-8 emulator</h2>
  </header>

  <canvas width="512" height="256"></canvas>

  <table id="keyboard" style="display:none">
    <tr><td>1</td><td>2</td><td>3</td><td>C</td></tr>
    <tr><td>4</td><td>5</td><td>6</td><td>D</td></tr>
    <tr><td>7</td><td>8</td><td>9</td><td>E</td></tr>
    <tr><td>A</td><td>0</td><td>B</td><td>F</td></tr>
  </table>

  <input type="file" id="local_rom" style="visibility:hidden"/>

  <footer>
    <ul>
      <li>Source code <a href="https://github.com/merwaaan/cheapo.js">here</a></li>
      <li>ROMs from <a href="http://www.pong-story.com/chip8/">David Winter's emulator</a></li>
      <li>Nice technical references: <a href="http://devernay.free.fr/hacks/chip8/C8TECH10.HTM">Cowgod's</a> and <a href="http://mattmik.com/chip8.html">Matthew Mikolay's</a></li>
    </ul></ul>
  </footer>

  <script>

    // Go Cheapo, go!

    window.addEventListener('load', function() {

      Cheapo.Main.init();

      // GUI

      var gui = new dat.GUI();

      var game = gui.addFolder('Game');

      // Select one of the hosted ROMS...

      var games = [
        ['Animal Race', 'Astro Dodge', 'Blinky', 'Blitz', 'Brix', 'Hidden', 'Maze', 'Missile', 'Space Invaders', 'Tetris', 'Tic Tac', 'UFO'], // CHIP-8
        ['Alien', 'Super Blinky', 'Car Race', 'Field!', 'Joust', 'Sokoban', 'Super Astro Dodge', 'U-Boat'] // Super CHIP-8
      ];
      var hosted = game.add({load:''}, 'load', games[0].concat(games[1])).name('Select');

      function category(label, n) {
        var select = document.querySelector('select');
        var group = document.createElement('optgroup');
        group.label = label;
        for (var i = 0; i < n; ++i)
          group.appendChild(select.querySelectorAll('option')[0]);
        select.appendChild(group);
      }

      category('CHIP-8', games[0].length);
      category('SUPER CHIP-8', games[1].length);

      hosted.onChange(function(name) {

        var request = new XMLHttpRequest(name);
        request.open('GET', 'roms/' + name);
        request.overrideMimeType("text/plain; charset=x-user-defined");
        request.responseType = 'arraybuffer';

        request.onload = function() {

          Cheapo.Main.load(request.response);

          // BLITZ cannot be won with wrap mode on
          if (name == 'BLITZ')
            Cheapo.Video.wrap = false;
        };

        request.send();
      });

      // ... Or load a local file

      var file_select = document.querySelector('input#local_rom');

      game.add({
        load: function() {
          file_select.click();
        }
      }, 'load').name('Load a file');


      file_select.addEventListener('change', function() {

        var reader = new FileReader();
        reader.addEventListener('load', function() {
          Cheapo.Main.load(this.result);
        });

        reader.readAsArrayBuffer(this.files[0]);
      });

      game.open();

      var cpu = gui.addFolder('CPU');
      cpu.add(Cheapo.CPU, 'frequency').min(0).max(1000);

      var video = gui.addFolder('Video')
      video.add(Cheapo.Video, 'scale').min(1).max(10).step(1);
      video.addColor(Cheapo.Video, 'color');
      video.addColor(Cheapo.Video, 'background');

      var audio = gui.addFolder('Audio');
      audio.add(Cheapo.Audio, 'volume').min(0).max(100).step(1);
      audio.add(Cheapo.Audio, 'frequency').min(0).max(1000).step(1);

      var input = gui.addFolder('Input');
      input.add(Cheapo.Input, 'visual_keyboard').name('Visual keyboard');
    });

  </script>

</body>
</html>